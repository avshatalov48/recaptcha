# b01110011.recaptcha

reCAPTCHA v3 - это бесплатный сервис, который защищает ваш сайт от спама. Капча является невидимой для пользователей. *(что означает, не нужно больше тыкать на картинки или вводить текст)*  

Модуль встраивает данный механизм защиты на сайт.  
  
Есть поддержка многосайтовости.  
  
Расширение cURL должно быть включено в PHP.  
  
**Для работы модуля:**
1. Получить ключи рекапчи.
2. Вставить скрытое поле в форму.
3. Произвести быструю настройку на странице настроек модуля.

**Получение ключей:**

Авторизоваться через google аккаунт и зарегистрировать свой сайт по ссылке  
https://www.google.com/recaptcha/admin/create  
и получить ключи.  
*(при ситуации когда есть тестовый сайт, вписывайте его в поле "Домены")*  

**Вставить код в формы:**

скрытое поле в которое будет вставляться токен при отправке формы
```html
<input type="hidden" name="recaptcha_token" value="">
```

**Если нужно защитить от спама:**

Регистрацию  
> Находим блок "Регистрации" и жмём на "Включить капчу"  
  
Добавление данных в модуль "Веб формы"  
> Находим блок "Веб формы" и выбираем нужные формы для защиты.    
  
Добавление данных в модуль "Инфоблоки"  
> Находим блок "Инфоблоки" и выбираем нужные инфоблоки для защиты.  
  
Форму обратной связи main.feedback  
> Находим блок "Форма обратной связи" и выбираем нужные почтовые шаблоны для защиты.  

**Как вывести сообщение об ошибке капчи в "Форме обратной связи main.feedback"?**
Нужно скопировать компонент (папку main.feedback) из *bitrix\components\bitrix\main.feedback* в *local\components\bitrix\main.feedback* .  
Далее открыть файл component.php на редактирование.  
Найти строки:  
```php
$_SESSION["MF_NAME"] = htmlspecialcharsbx($_POST["user_name"]);
$_SESSION["MF_EMAIL"] = htmlspecialcharsbx($_POST["user_email"]);
LocalRedirect($APPLICATION->GetCurPageParam("success=".$arResult["PARAMS_HASH"], Array("success")));
```
Заменить их на:  
```php
if($ex = $APPLICATION->GetException())
{
    $arResult["ERROR_MESSAGE"][] = $ex->GetString();
}
else
{
    $_SESSION["MF_NAME"] = htmlspecialcharsbx($_POST["user_name"]);
    $_SESSION["MF_EMAIL"] = htmlspecialcharsbx($_POST["user_email"]);
    LocalRedirect($APPLICATION->GetCurPageParam("success=".$arResult["PARAMS_HASH"], Array("success")));
}
```
И всё! Вывод ошибок капчи будет работать.  

**Как получить токен, если я отправляю данные через AJAX?**
```js
window.recaptcha.getToken()
```

**Как работает модуль?** *(для программистов)*

js часть:  
При загрузке страницы, в объекте window создаётся объект recaptcha, в котором запрашивается и хранится токен.  
Каждые 100 секунд токен обновляется.  
Далее ищутся все поля с именем recaptcha_token *(input[name=recaptcha_token])* и к формам, в которых эти поля находятся, вешается событие onsubmit.  
При отправке формы помещается токен в скрытое поле и запрашивается новый токен.  
Такой механизм запроса токена "заранее", реализован с целью убрать задержку перед отправкой формы.  
  
php часть:  
При построении каждой страницы, регистрируются события для проверки токена, отправленного вместе с формой. Этот токен и секретный ключ отправляются на сервер гугла для получения результата.  
Если токен верный и пришедшая оценка выше или равна той что в настройках, тогда данные формы обрабатываются, иначе выводится текст с ошибкой.  

**Как тестировать?**

Открываем консоль в браузере и уничтожаем объект recaptcha = null (window.recaptcha), перед добавлением данных.
Если была сделана соответствующая настройка на странице настроек модуля (выбран инфоблок), то после добавления данных будет ошибка капчи.